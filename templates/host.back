<!DOCTYPE html>
<html>
<head>
    <title>Kahoot Clone - Host</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; background: #f2f2f2; margin: 0; padding: 0; overflow: hidden; }
        
        /* LAYOUTS */
        .view-section { display: none; padding: 20px; height: 100vh; box-sizing: border-box; position: relative; flex-direction: column; width: 100%;}
        #lobby-view { background: #46178f; color: white; display: flex;}
        #question-view { background: white; }
        #leaderboard-view { background: #3e147f; color: white; }
        #final-view { background: #18003a; color: white; }

        /* COUNTDOWN ANIMATION STYLES (NEW) */
        #countdown-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); z-index: 3000;
            justify-content: center; align-items: center;
        }
        .count-num {
            font-size: 15em; font-weight: bold; color: white;
            animation: zoomFade 0.9s ease-out forwards; /* The Zoom Effect */
        }
        @keyframes zoomFade {
            0% { transform: scale(0.1); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: scale(2.5); opacity: 0; }
        }

        /* QR CODE STYLE */
        #qrcode { margin: 20px auto; padding: 15px; background: white; border-radius: 10px; display: inline-block; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .snowflake { position: fixed; top: -50px; color: white; user-select: none; pointer-events: none; z-index: 5; animation-name: fall; animation-timing-function: linear; }
        @keyframes fall { to { transform: translateY(110vh); } }
        .p-avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid white; margin-right: 10px; vertical-align: middle;}
        .lobby-card { background: rgba(255,255,255,0.2); padding: 10px 20px; margin: 10px; border-radius: 30px; display: flex; align-items: center; font-weight: bold; font-size: 1.2em; z-index: 10; }
        
        /* LEADERBOARD */
        #lb-container { position: relative; width: 60%; margin: 0 auto; height: 600px; }
        .lb-entry { position: absolute; left: 0; right: 0; height: 70px; background: rgba(255,255,255,0.1); padding: 5px 20px; font-size: 1.5em; display: flex; justify-content: space-between; align-items: center; border-radius: 10px; transition: top 0.6s ease-in-out; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .lb-left { display: flex; align-items: center; } 
        .lb-rank { font-weight: bold; width: 40px; } .lb-name { margin-left: 10px; } .lb-score { font-family: monospace; font-weight: bold; }

        /* PODIUM */
        #podium-container { display: flex; align-items: flex-end; justify-content: center; height: 60%; width: 100%; gap: 20px; margin-top: 50px;}
        .podium-column { display: flex; flex-direction: column; align-items: center; justify-content: flex-end; width: 150px; opacity: 0; transition: opacity 1s, transform 1s; transform: translateY(50px);}
        .podium-block { width: 100%; background: linear-gradient(to bottom, #864cbf, #46178f); border-top: 5px solid #fff; position: relative;}
        .podium-img { width: 80px; height: 80px; border-radius: 50%; border: 4px solid white; margin-bottom: 10px; background: #333;}
        .podium-name { font-size: 1.5em; font-weight: bold; margin-bottom: 5px; word-wrap: break-word;}
        .podium-score { font-size: 1.2em; background: rgba(0,0,0,0.3); padding: 5px 10px; border-radius: 10px; margin-bottom: 10px;}
        .p-1 { height: 320px; order: 2; } .p-1 .podium-img { width: 110px; height: 110px; border-color: gold; }
        .p-2 { height: 220px; order: 1; } .p-3 { height: 150px; order: 3; }
        #runners-up { display: flex; justify-content: center; gap: 40px; margin-top: 30px; font-size: 1.5em; }
        .runner-card { background: rgba(255,255,255,0.1); padding: 10px 30px; border-radius: 50px; display: flex; align-items: center;}

        /* QUESTION */
        .options { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; flex-grow: 1; width: 100%; margin-bottom: 70px;}
        .opt { display: flex; align-items: center; justify-content: center; color: white; font-size: 2em; font-weight: bold; border-radius: 5px; transition: all 0.3s;}
        .A { background: #e21b3c; } .B { background: #1368ce; } .C { background: #d89e00; } .D { background: #26890c; }
        .dimmed { opacity: 0.2; transform: scale(0.95); filter: grayscale(100%); }
        .correct-highlight { transform: scale(1.05); box-shadow: 0 0 30px #fff; z-index: 10; border: 5px solid white; }
        #timer-circle { width: 80px; height: 80px; border-radius: 50%; background: #864cbf; color: white; font-size: 2.5em; line-height: 80px; margin: 20px auto; flex-shrink: 0;}
        #question-text { font-size: 2.5em; margin-bottom: 20px; flex-shrink: 0;}
        #status-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #333; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; z-index: 100;}
        button#main-btn { padding: 10px 20px; font-size: 1.2em; cursor: pointer; background: #fff; border: none; border-radius: 4px; color: #333;}
        
        /* OVERLAYS */
        #round-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); color: white; z-index: 999; justify-content: center; align-items: center; flex-direction: column;}
        #overlay-text { font-size: 5em; font-weight: bold; text-transform: uppercase; }
        #start-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; color: white; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer;}
        #start-overlay h1 { font-size: 3em; margin-bottom: 20px; }
        #start-overlay p { font-size: 1.5em; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
    </style>
</head>
<body>

    <div id="start-overlay" onclick="enableAudio()">
        <h1>Host Screen</h1>
        <p>▶ Click to enable audio & generate QR Code</p>
    </div>

    <div id="countdown-overlay"></div>

    <div id="round-overlay"><div id="overlay-text">Time's Up!</div></div>

    <div id="lobby-view" class="view-section">
        <h1 id="join-url-text">Join at...</h1>
        <div id="qrcode"></div>
        <h2>Waiting for players...</h2>
        <div id="lobby-player-list" style="display: flex; flex-wrap: wrap; justify-content: center;"></div>
    </div>

    <div id="question-view" class="view-section">
        <div id="question-text">Question...</div>
        <div id="timer-circle">30</div>
        <div class="options" id="options-display">
            <div class="opt A" id="optA"></div> <div class="opt B" id="optB"></div> 
            <div class="opt C" id="optC"></div> <div class="opt D" id="optD"></div>
        </div>
    </div>

    <div id="leaderboard-view" class="view-section">
        <h1>Leaderboard</h1>
        <div id="lb-container"></div>
    </div>

    <div id="final-view" class="view-section">
        <h1>GAME OVER</h1>
        <div id="podium-container">
            <div class="podium-column p-2" id="podium-2">
                <img class="podium-img" id="img-2" src="">
                <div class="podium-name" id="name-2"></div>
                <div class="podium-score" id="score-2"></div>
                <div class="podium-block">2</div>
            </div>
            <div class="podium-column p-1" id="podium-1">
                <img class="podium-img" id="img-1" src="">
                <div class="podium-name" id="name-1"></div>
                <div class="podium-score" id="score-1"></div>
                <div class="podium-block">1</div>
            </div>
            <div class="podium-column p-3" id="podium-3">
                <img class="podium-img" id="img-3" src="">
                <div class="podium-name" id="name-3"></div>
                <div class="podium-score" id="score-3"></div>
                <div class="podium-block">3</div>
            </div>
        </div>
        <div id="runners-up"></div>
    </div>

    <div id="status-bar">
        <div id="answer-count">Answers: 0</div>
        <button id="main-btn" onclick="handleMainButton()">Start Game</button>
    </div>

    <script>
        const socket = io();
        let timerInterval, gameState = 'lobby', lbCache = {};
        let snowInterval; 
        
        const lobbyMusic = new Audio('/static/lobby.mp3'); lobbyMusic.loop = true; lobbyMusic.volume = 0.6;
        const bgMusic = new Audio('/static/music.mp3'); bgMusic.loop = true; bgMusic.volume = 0.5;
        const gongSound = new Audio('/static/gong.mp3'); 
        const trumpetSound = new Audio('/static/trumpet.mp3');
        const pointsSound = new Audio('/static/points.mp3');

        function enableAudio() {
            document.getElementById('start-overlay').style.display = 'none';
            lobbyMusic.play().catch(e => console.log("Audio failed:", e));
            startSnow();
            const base_url = window.location.origin; 
            document.getElementById('join-url-text').innerText = `Join at ${base_url}`;
            document.getElementById('qrcode').innerHTML = "";
            new QRCode(document.getElementById("qrcode"), { text: base_url, width: 200, height: 200, colorDark : "#000000", colorLight : "#ffffff", correctLevel : QRCode.CorrectLevel.H });
        }

        // --- COUNTDOWN LOGIC (NEW) ---
        function runCountdown(onComplete) {
            const overlay = document.getElementById('countdown-overlay');
            overlay.style.display = 'flex';
            
            let count = 3;
            
            function showNumber() {
                if(count > 0) {
                    // Create element to trigger animation
                    overlay.innerHTML = `<div class="count-num">${count}</div>`;
                    count--;
                    // Wait 1s (0.9s animation + buffer)
                    setTimeout(showNumber, 1000);
                } else {
                    // Done
                    overlay.style.display = 'none';
                    overlay.innerHTML = '';
                    onComplete();
                }
            }
            showNumber();
        }

        function handleMainButton() {
            if (gameState === 'lobby') {
                lobbyMusic.pause();
                stopSnow();
                
                // Trigger Countdown -> Then Game Start
                runCountdown(() => {
                    socket.emit('next_question');
                });
            }
            else if (gameState === 'question') socket.emit('time_up');
            else if (gameState === 'leaderboard') socket.emit('next_question');
            else if (gameState === 'game_over') location.reload();
        }

        // ... Rest of the script is unchanged ...
        function switchView(viewId) {
            document.querySelectorAll('.view-section').forEach(el => el.style.display = 'none');
            document.getElementById(viewId).style.display = 'flex';
        }
        function createSnowflake() {
            const flake = document.createElement('div'); flake.classList.add('snowflake'); flake.innerText = '❄'; flake.style.left = Math.random() * 100 + 'vw';
            const duration = Math.random() * 3 + 2; flake.style.animationDuration = duration + 's'; flake.style.opacity = Math.random(); flake.style.fontSize = Math.random() * 20 + 10 + 'px';
            document.body.appendChild(flake); setTimeout(() => { flake.remove(); }, duration * 1000);
        }
        function startSnow() { if(!snowInterval) snowInterval = setInterval(createSnowflake, 100); }
        function stopSnow() { clearInterval(snowInterval); snowInterval = null; document.querySelectorAll('.snowflake').forEach(el => el.remove()); }
        
        socket.on('update_player_list', (players) => {
            if(gameState !== 'lobby') return;
            const list = document.getElementById('lobby-player-list');
            list.innerHTML = "";
            for (let id in players) {
                let p = players[id];
                let div = document.createElement('div');
                div.className = 'lobby-card';
                div.innerHTML = `<img src="/static/avatars/${p.avatar}.png" class="p-avatar"> ${p.name}`;
                list.appendChild(div);
            }
            document.getElementById('answer-count').innerText = `Players: ${Object.keys(players).length}`;
        });

        socket.on('new_question', (q) => {
            gameState = 'question'; switchView('question-view');
            document.querySelectorAll('.opt').forEach(el => { el.className = `opt ${el.id.replace('opt', '')}`; });
            document.getElementById('round-overlay').style.display = 'none';
            document.getElementById('question-text').innerText = q.question;
            document.getElementById('optA').innerText = q.option_a; 
            document.getElementById('optB').innerText = q.option_b; 
            document.getElementById('optC').innerText = q.option_c; 
            document.getElementById('optD').innerText = q.option_d;
            bgMusic.currentTime = 0; bgMusic.play().catch(e=>{});
            startTimer(q.duration);
        });

        socket.on('round_over', (data) => {
            gameState = 'results'; stopTimer(); 
            gongSound.currentTime = 0; gongSound.play().catch(e => {});
            const overlay = document.getElementById('round-overlay');
            overlay.style.display = 'flex';
            document.getElementById('main-btn').innerText = "Loading Leaderboard...";
            setTimeout(() => {
                overlay.style.display = 'none';
                ['A', 'B', 'C', 'D'].forEach(opt => {
                    const el = document.getElementById(`opt${opt}`);
                    if(opt === data.correct_option) el.classList.add('correct-highlight');
                    else el.classList.add('dimmed');
                });
                setTimeout(() => { socket.emit('request_leaderboard'); }, 4000);
            }, 2000); 
        });

        socket.on('show_leaderboard', (top5) => {
            gameState = 'leaderboard'; switchView('leaderboard-view');
            document.getElementById('main-btn').innerText = "Next Question";
            pointsSound.currentTime = 0; pointsSound.play().catch(e=>{});
            const container = document.getElementById('lb-container');
            for(let key in lbCache) lbCache[key].active = false;
            top5.forEach((p, index) => {
                let entry = lbCache[p.name];
                let oldScore = 0;
                if (!entry) {
                    const el = document.createElement('div');
                    el.className = 'lb-entry'; el.style.top = '600px'; 
                    el.innerHTML = `<div class="lb-left"><span class="lb-rank"></span><img src="/static/avatars/${p.avatar}.png" class="p-avatar"><span class="lb-name">${p.name}</span></div><span class="lb-score">0</span>`;
                    container.appendChild(el);
                    entry = { element: el, currentScore: 0 }; lbCache[p.name] = entry;
                } else { oldScore = entry.currentScore; }
                entry.active = true;
                setTimeout(() => { entry.element.style.top = (index * 90) + 'px'; }, 50);
                entry.element.querySelector('.lb-rank').innerText = (index + 1);
                if (oldScore !== p.score) {
                    animateValue(entry.element.querySelector('.lb-score'), oldScore, p.score, 1500);
                    entry.currentScore = p.score;
                }
            });
            for(let key in lbCache) { if(!lbCache[key].active) { lbCache[key].element.remove(); delete lbCache[key]; } }
        });

        socket.on('game_over', (players) => {
            switchView('final-view'); gameState = 'game_over';
            document.getElementById('main-btn').innerText = "New Game";
            document.getElementById('status-bar').style.display = 'none';
            const sorted = Object.values(players).sort((a,b) => b.score - a.score);
            const top5 = sorted.slice(0, 5);
            if(top5[0]) fillPodium('1', top5[0]); 
            if(top5[1]) fillPodium('2', top5[1]); 
            if(top5[2]) fillPodium('3', top5[2]); 
            const runnerContainer = document.getElementById('runners-up');
            runnerContainer.innerHTML = '';
            if(top5[3]) runnerContainer.innerHTML += `<div class="runner-card"><img src="/static/avatars/${top5[3].avatar}.png" class="p-avatar"> 4. ${top5[3].name} (${top5[3].score})</div>`;
            if(top5[4]) runnerContainer.innerHTML += `<div class="runner-card"><img src="/static/avatars/${top5[4].avatar}.png" class="p-avatar"> 5. ${top5[4].name} (${top5[4].score})</div>`;
            trumpetSound.play().catch(e=>{});
            setTimeout(() => { if(top5[2]) showPodium('3'); }, 4000);
            setTimeout(() => { if(top5[1]) showPodium('2'); }, 8000);
            setTimeout(() => { if(top5[0]) { showPodium('1'); fireConfetti(); } }, 14000);
        });

        function fillPodium(rank, p) { document.getElementById(`name-${rank}`).innerText = p.name; document.getElementById(`score-${rank}`).innerText = p.score; document.getElementById(`img-${rank}`).src = `/static/avatars/${p.avatar}.png`; }
        function showPodium(rank) { const el = document.getElementById(`podium-${rank}`); el.style.opacity = '1'; el.style.transform = 'translateY(0)'; }
        function animateValue(obj, start, end, duration) { let startTimestamp = null; const step = (timestamp) => { if (!startTimestamp) startTimestamp = timestamp; const progress = Math.min((timestamp - startTimestamp) / duration, 1); obj.innerHTML = Math.floor(progress * (end - start) + start); if (progress < 1) window.requestAnimationFrame(step); }; window.requestAnimationFrame(step); }
        function fireConfetti() { var duration = 5 * 1000; var animationEnd = Date.now() + duration; var defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 }; var interval = setInterval(function() { var timeLeft = animationEnd - Date.now(); if (timeLeft <= 0) { return clearInterval(interval); } var particleCount = 50 * (timeLeft / duration); confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } })); confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } })); }, 250); }
        function randomInRange(min, max) { return Math.random() * (max - min) + min; }
        socket.on('update_answer_count', (data) => { document.getElementById('answer-count').innerText = `Answers: ${data.count} / ${data.total}`; });
        function startTimer(duration) { clearInterval(timerInterval); let timeLeft = duration; const timerDiv = document.getElementById('timer-circle'); timerDiv.innerText = timeLeft; timerInterval = setInterval(() => { timeLeft--; timerDiv.innerText = timeLeft; if(timeLeft <= 0) { clearInterval(timerInterval); socket.emit('time_up'); } }, 1000); }
        function stopTimer() { clearInterval(timerInterval); bgMusic.pause(); }
    </script>
</body>
</html>
